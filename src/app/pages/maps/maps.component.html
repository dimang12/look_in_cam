<div class="px-4 pb-2 flex flex-col h-full" [class.drawer-open]="reportDrawerOpen">
  <!-- Mobile-friendly toolbar -->
  <div class="map-toolbar flex flex-col sm:flex-row sm:items-center p-3 mb-3 space-y-2 sm:space-y-0 sm:space-x-2">
    <div class="flex items-center justify-between w-full sm:w-auto">
      <h2 class="flex items-center text-lg sm:text-xl font-medium">ផែនទី</h2>
      <!-- Mobile menu toggle -->
      <button class="sm:hidden" mat-icon-button (click)="toggleMobileMenu()" aria-label="Menu">
        <mat-icon>{{ showMobileMenu ? 'close' : 'menu' }}</mat-icon>
      </button>
    </div>
    
    <!-- Mobile collapsible menu -->
    <section class="flex flex-col sm:flex-row gap-2 items-stretch sm:items-center" 
             [class.hidden]="!showMobileMenu" 
             [class.sm:flex]="true">
      
      <!-- Drawing controls - mobile responsive -->
      <div class="flex flex-col sm:flex-row items-stretch sm:items-center gap-2 p-2 bg-gray-50 rounded-lg" *ngIf="reportDrawerOpen">
        <label class="text-sm text-gray-700 font-medium sm:whitespace-nowrap">Draw:</label>
        <select class="flex-1 sm:flex-none px-3 py-2 border rounded-lg text-sm min-w-0" 
                [value]="selectedDrawMode" 
                (change)="setDrawMode($any($event.target).value)">
          <option value="marker">Marker</option>
          <option value="circle">Circle</option>
          <option value="polygon">Polygon</option>
          <option value="polyline">Polyline</option>
          <option value="rectangle">Rectangle</option>
        </select>
        <ui-button type="ghost" size="sm" htmlType="button" (clicked)="toggleDrawing()" class="justify-center">
          <span class="flex flex-row items-center p-1">
            <i class="material-icons text-base">edit</i>
            <span class="ml-1 hidden sm:inline">{{ drawingEnabled ? 'Stop Drawing' : 'Start Drawing' }}</span>
            <span class="ml-1 sm:hidden">{{ drawingEnabled ? 'Stop' : 'Draw' }}</span>
          </span>
        </ui-button>
      </div>
      
      <!-- Add report button - mobile responsive -->
      <ui-button extraClasses="rounded-lg sm:rounded-pill w-full sm:w-auto" 
                 type="primary" 
                 size="sm" 
                 accent="purple" 
                 htmlType="button" 
                 (clicked)="addReportMarker()">
        <span class="flex flex-row items-center justify-center p-2">
          <i class="material-icons mr-2">add_location</i>
          <span class="hidden sm:inline">បញ្ចូលរបាយការណ៍</span>
          <span class="sm:hidden">Add Report</span>
        </span>
      </ui-button>
    </section>
  </div>



  <!-- Mobile-responsive navigation -->
  <nav class="maps-subtypes flex flex-col lg:flex-row gap-3 mb-3">
    <!-- Map type tabs - full width on mobile -->
    <div class="flex-1 min-w-0">
      <app-map-type-tabs 
        [subtypes]="subtypes" 
        [selectedType]="selectedType || ''"
        (typeSelected)="selectType($event)">
      </app-map-type-tabs>
    </div>
  
    <!-- Controls section - stack on mobile -->
    <div class="flex flex-col sm:flex-row items-stretch sm:items-center gap-2 lg:gap-3">
      <!-- Calendar controls - responsive -->
      <div class="order-2 sm:order-1">
        <app-calendar-controls
          [dateRangeMode]="dateRangeMode"
          [selectedDate]="selectedDate"
          [dateRangeLabel]="getDateRangeLabel()"
          (dateRangeModeChange)="setDateRangeMode($event)"
          (selectedDateChange)="onDateChange($event)"
          (previousPeriod)="goToPreviousPeriod()"
          (nextPeriod)="goToNextPeriod()">
        </app-calendar-controls>
      </div>
      
      <!-- Data panel button - responsive -->
      <div class="order-1 sm:order-2">
        <ui-button type="ghost" 
                   size="sm" 
                   htmlType="button" 
                   (clicked)="toggleDataPanel()" 
                   aria-label="Data"
                   class="w-full sm:w-auto h-12 sm:h-14">
          <span class="flex flex-row items-center justify-center gap-2 p-2">
            <i class="material-icons text-sm">grid_view</i>
            <span class="text-sm sm:text-base">បង្ហាញទិន្នន័យ</span>
          </span>
        </ui-button>
      </div>
    </div>
  </nav>

  <div class="map-and-drawer grid flex-1 pb-4 gap-4" [class.drawer-open]="reportDrawerOpen">
    <!-- Map Container with overlay backdrop -->
    <div class="map-container-wrapper relative h-full">
      
      <!-- Data Panel - Floating -->
      <aside *ngIf="dataPanelOpen" class="data-panel bg-transparent" aria-label="Data panel">
        <div class="panel-header flex justify-between items-center px-4 py-3 border-b border-gray-200">
          <h3 class="panel-title m-0 text-base font-semibold text-gray-900">ទិន្នន័យ</h3>
          <button mat-icon-button type="button" (click)="toggleDataPanel()" aria-label="Close panel" class="p-0">
            <mat-icon>close</mat-icon>
          </button>
        </div>
        <div class="panel-content flex-1 overflow-y-auto">
          <div *ngIf="markers.length === 0" class="empty-state p-6 text-center text-gray-500">No markers</div>
          <ul class="divide-y divide-gray-200">
            <li *ngFor="let m of markers; let i = index" class="marker-item px-4 py-3 hover:bg-gray-50 transition">
              <div class="flex justify-between items-start">
                <div class="flex-1 cursor-pointer" (click)="zoomToMarker(m)">
                  <div class="marker-title font-semibold text-gray-900 text-sm">{{ m.title }}</div>
                  <div class="marker-type text-gray-600 text-xs mt-1" *ngIf="m.type">{{ getTypeLabel(m.type) }}</div>
                  <div class="marker-coords text-gray-500 text-xs mt-1 font-mono">
                    {{ m.position.lat.toFixed(4) }}, {{ m.position.lng.toFixed(4) }}
                  </div>
                  <div class="marker-description text-gray-600 text-xs mt-2" *ngIf="m.description">{{ m.description }}</div>
                </div>
                <div class="flex gap-1 ms-2">
                  <button mat-icon-button type="button" aria-label="Edit" (click)="editMarker(m, i)">
                    <mat-icon>edit</mat-icon>
                  </button>
                  <button mat-icon-button color="warn" type="button" aria-label="Delete" (click)="deleteMarker(i, m)">
                    <mat-icon>delete</mat-icon>
                  </button>
                </div>
              </div>
            </li>
          </ul>
        </div>
      </aside>

      <div class="map-container h-full relative">
        <!-- Mobile-optimized search box -->
        <div class="absolute top-2 left-2 right-2 sm:left-1/2 sm:right-auto sm:transform sm:-translate-x-1/2 z-10" *ngIf="hasApiKey && googleLoaded">
          <div class="relative">
            <div class="flex items-center bg-white rounded-lg shadow-lg border px-3 py-2 w-full sm:min-w-80 sm:w-auto">
              <mat-icon class="text-gray-500 mr-2 flex-shrink-0">search</mat-icon>
              <input 
                #searchInput
                type="text" 
                placeholder="Search places..." 
                class="flex-1 outline-none text-base sm:text-sm bg-transparent min-w-0"
                (input)="onSearchInput($event)"
                (keydown.enter)="selectPlace(searchInput.value)"
                (keydown.arrowdown)="navigateAutocomplete(1)"
                (keydown.arrowup)="navigateAutocomplete(-1)"
                (keydown.escape)="hideAutocomplete()"
                (blur)="onSearchBlur()"
              />
              <button 
                mat-icon-button 
                (click)="selectPlace(searchInput.value)"
                class="ml-2 p-2 flex-shrink-0">
                <mat-icon class="!text-lg sm:!text-base">arrow_forward</mat-icon>
              </button>
            </div>
            
            <!-- Mobile-optimized autocomplete dropdown -->
            <div 
              class="absolute top-full left-0 right-0 bg-white border border-gray-200 rounded-b-lg shadow-lg max-h-60 sm:max-h-80 overflow-y-auto z-20"
              *ngIf="showAutocomplete && autocompletePredictions.length > 0">
              <div 
                *ngFor="let prediction of autocompletePredictions; let i = index"
                class="flex items-center px-4 py-4 sm:py-3 hover:bg-gray-50 active:bg-gray-100 cursor-pointer border-b border-gray-100 last:border-b-0 touch-manipulation"
                [class.bg-blue-50]="i === selectedIndex"
                (click)="selectPrediction(prediction)"
                (mouseenter)="selectedIndex = i"
                (touchstart)="selectedIndex = i">
                <mat-icon class="text-gray-400 mr-3 !text-lg sm:!text-base flex-shrink-0">place</mat-icon>
                <div class="flex-1 min-w-0">
                  <div class="text-base sm:text-sm font-medium text-gray-900 truncate">{{ prediction.structured_formatting.main_text }}</div>
                  <div class="text-sm sm:text-xs text-gray-500 truncate">{{ prediction.structured_formatting.secondary_text }}</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <ng-container class="h-full flex p-3 rounded-lg" *ngIf="hasApiKey && googleLoaded; else noKey">
          <!-- Using circles instead of deprecated markers -->
          <google-map
            height="100%"
            width="100%"
            [center]="center"
            [zoom]="zoom"
            [options]="options"
            (mapClick)="onMapClick($event)"
            (mapInitialized)="onMapInitialized($event)">

            <map-circle
              *ngFor="let m of markers"
              [center]="m.position"
              [radius]="getCircleRadius()"
              [options]="getCircleOptions(m)"
              (circleClick)="openInfoForCircle(m)">
            </map-circle>

            <map-info-window>
              <div>
                <div class="fw-bold">{{ selectedMarkerTitle }}</div>
                <div class="text-muted small" *ngIf="selectedMarkerType">{{ getTypeLabel(selectedMarkerType) }}</div>
                <div class="text-muted small" *ngIf="selectedMarkerDescription">{{ selectedMarkerDescription }}</div>
              </div>
            </map-info-window>
          </google-map>
        </ng-container>


        <ng-template #noKey>
          <div class="map-placeholder p-3 border">
            <p>
              Google Maps API key is not set. Please set <code>environment.googleMapsApiKey</code> to a valid key.
            </p>
          </div>
        </ng-template>
      </div>
    </div>

    <!-- Right drawer -->
    <aside *ngIf="reportDrawerOpen" class="report-drawer" aria-label="Report drawer">
      <div class="drawer-content">
        <div class="drawer-header">
          <h3 class="drawer-title">Add Report</h3>
          <button mat-icon-button type="button" (click)="closeReportDrawer()" aria-label="Close drawer" class="close-btn">
            <mat-icon>close</mat-icon>
          </button>
        </div>

        <form class="report-form" (ngSubmit)="saveReport()" *ngIf="reportDrawerOpen">
          <!-- Title Field -->
          <mat-form-field appearance="outline" class="w-100">
            <mat-label>Title</mat-label>
            <input matInput [(ngModel)]="report.title" name="title" placeholder="Marker title" />
          </mat-form-field>

          <!-- Type Field -->
          <mat-form-field appearance="outline" class="w-100">
            <mat-label>Type</mat-label>
            <mat-select [(ngModel)]="report.type" name="type">
              <mat-option *ngFor="let s of subtypes" [value]="s.key">{{ s.label }}</mat-option>
            </mat-select>
          </mat-form-field>

          <!-- Marker Image URL -->
          <mat-form-field appearance="outline" class="w-100">
            <mat-label>Marker Image URL (optional)</mat-label>
            <input matInput [(ngModel)]="report.imageUrl" name="imageUrl" placeholder="https://example.com/image.jpg" />
            <mat-hint>Add a custom image for this marker (circular photo)</mat-hint>
          </mat-form-field>

          <!-- Crime-specific fields -->
          <ng-container *ngIf="report.type && ['border','crime'].includes(report.type)">
            <!-- Description -->
            <mat-form-field appearance="outline" class="w-100">
              <mat-label>Description</mat-label>
              <textarea matInput [(ngModel)]="report.description" name="description" rows="3" placeholder="Details about the incident"></textarea>
            </mat-form-field>

            <!-- Crime Type -->
            <mat-form-field appearance="outline" class="w-100">
              <mat-label>Crime Type</mat-label>
              <input matInput [(ngModel)]="report.crimeType" name="crimeType" placeholder="e.g. Theft, Assault" />
            </mat-form-field>

            <!-- Address -->
            <mat-form-field appearance="outline" class="w-100">
              <mat-label>Address</mat-label>
              <input matInput [(ngModel)]="report.address" name="address" placeholder="Optional address or landmark" />
            </mat-form-field>

            <!-- Attachments -->
            <div class="attachment-group">
              <label class="attachment-label">Attachments (upload image or paste URL)</label>

              <div class="attachment-actions">
                <input type="file" accept="image/*" #attachmentInput (change)="onAttachmentFileSelected($event)" hidden />
                <button mat-stroked-button color="primary" type="button" (click)="attachmentInput.click()" [disabled]="uploadingAttachment">
                  <mat-icon>cloud_upload</mat-icon>
                  {{ uploadingAttachment ? 'Uploading…' : 'Upload image' }}
                </button>
                <div class="text-danger small" *ngIf="uploadError">{{ uploadError }}</div>
              </div>

              <div *ngFor="let a of report.attachments; let i = index" class="attachment-item">
                <mat-form-field appearance="outline" class="flex-1">
                  <mat-label>Attachment {{ i + 1 }}</mat-label>
                  <input matInput [(ngModel)]="report.attachments[i]" name="attachment{{i}}" placeholder="https://..." />
                </mat-form-field>
                <button mat-icon-button color="warn" type="button" (click)="report.attachments.splice(i,1)" aria-label="Remove attachment">
                  <mat-icon>delete</mat-icon>
                </button>
              </div>
              <button mat-stroked-button color="primary" type="button" (click)="report.attachments.push('')" class="add-attachment-btn">
                <mat-icon>add</mat-icon>
                Add attachment URL
              </button>
            </div>

            <!-- Reported By -->
            <mat-form-field appearance="outline" class="w-100">
              <mat-label>Reported By (name)</mat-label>
              <input matInput [(ngModel)]="report.reportedBy.name" name="reportedByName" placeholder="Reporter name" />
            </mat-form-field>
          </ng-container>

          <!-- Location (point or polygon) -->
          <mat-form-field appearance="outline" class="w-100">
            <mat-label>Location</mat-label>
            <textarea matInput [(ngModel)]="report.locationText" name="locationText" rows="2" placeholder="Point: 11.5564,104.9282  •  Polygon: 11.56,104.92; 11.57,104.93; 11.58,104.94"></textarea>
          </mat-form-field>

          <!-- Hint -->
          <mat-hint class="hint-text">Tip: click on the map to fill point automatically, or finish a drawing to populate polygon/rectangle.</mat-hint>

          <!-- Action Buttons -->
          <div class="form-actions">
            <button mat-stroked-button color="primary" type="button" (click)="closeReportDrawer()">Cancel</button>
            <button mat-flat-button color="primary" type="submit">Save</button>
          </div>
        </form>
      </div>
    </aside>
  </div>
</div>
